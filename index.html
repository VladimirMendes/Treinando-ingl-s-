<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>English Dialogue Trainer</title>
  <style>
    :root{
      --bg:#0b1220; --card:#0f172a; --muted:#94a3b8; --text:#e2e8f0; --brand:#0ea5e9;
      --ok:#22c55e; --warn:#f59e0b; --err:#ef4444; --info:#93c5fd;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(180deg,#0b1220,#101a34);color:var(--text)}
    .app{max-width:1100px;margin:0 auto;padding:24px}
    .header{display:flex;gap:12px;align-items:center;margin-bottom:16px}
    .badge{background:rgba(14,165,233,.15);border:1px solid rgba(14,165,233,.35);color:#7dd3fc;padding:2px 8px;border-radius:999px;font-size:12px}
    h1{margin:0;font-size:24px}
    .row{display:grid;gap:16px}
    @media(min-width:1000px){.row{grid-template-columns:2fr 1fr}}
    .card{background:linear-gradient(180deg,rgba(148,163,184,.06),rgba(148,163,184,.02));border:1px solid rgba(148,163,184,.08);border-radius:14px;padding:16px;box-shadow:0 2px 6px rgba(0,0,0,.4)}
    .title{font-size:16px;margin:0 0 8px;color:#cbd5e1;font-weight:600}
    .sub{font-size:13px;color:var(--muted);margin:6px 0}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    button{background:linear-gradient(180deg,#0ea5e9,#0284c7);border:none;color:white;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:600;transition:.2s}
    button:hover{transform:scale(1.05)}
    button.secondary{background:linear-gradient(180deg,#1f2937,#111827);border:1px solid #334155}
    button.ghost{background:transparent;border:1px solid #334155;color:var(--text)}
    button.ok{background:linear-gradient(180deg,#22c55e,#16a34a)}
    button.warn{background:linear-gradient(180deg,#f59e0b,#d97706)}
    button.err{background:linear-gradient(180deg,#ef4444,#dc2626)}
    .chip{display:inline-block;padding:2px 8px;border-radius:999px;background:#071022;font-size:12px;color:#a5b4fc;margin-right:4px}
    .divider{height:1px;background:rgba(148,163,184,.08);margin:12px 0}
    input[type="text"]{width:100%;padding:10px;border-radius:10px;border:1px solid #334155;background:#071022;color:var(--text)}
    select{padding:8px;border-radius:8px;background:#071022;color:var(--text);border:1px solid #334155}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{border-bottom:1px dashed rgba(148,163,184,.08);padding:6px;text-align:left}
    .muted{color:var(--muted)}
    .hint{font-size:13px;color:#93c5fd}
    .small{font-size:13px}
    .feedback{font-weight:bold;margin-top:6px}
    .feedback.ok{color:var(--ok)}
    .feedback.warn{color:var(--warn)}
    .feedback.err{color:var(--err)}
    .feedback.info{color:var(--info)}
  </style>
</head>
<body>
<div class="app">
  <div class="header">
    <span class="badge">ğŸ‡ºğŸ‡² ConversaÃ§Ã£o</span>
    <h1>English Dialogue Trainer</h1>
  </div>

  <p class="sub">Treine <b>perguntas e respostas</b> em inglÃªs, ouÃ§a a pronÃºncia, fale, digite e acompanhe seu progresso! ğŸš€</p>

  <!-- ConfiguraÃ§Ãµes -->
  <div class="card">
    <p class="title">âš™ï¸ ConfiguraÃ§Ãµes</p>
    <div class="controls">
      <label><input type="radio" name="level" value="FÃ¡cil" checked> FÃ¡cil</label>
      <label><input type="radio" name="level" value="MÃ©dio"> MÃ©dio</label>
      <label><input type="radio" name="level" value="DifÃ­cil"> DifÃ­cil</label>
      <label style="margin-left:12px"><input type="checkbox" id="ckShowPt"> Mostrar traduÃ§Ã£o</label>
    </div>
    <div class="sub">Velocidade do Ã¡udio: 
      <input id="globalSpeed" type="range" min="0.5" max="2" step="0.1" value="1"> 
      <span id="globalSpeedValue">1x</span>
    </div>
    <div class="sub">â­ Pontos: <b id="kpiScore">0</b> | ğŸ”¥ Streak: <b id="kpiStreak">0</b></div>
  </div>

  <div class="row" style="margin-top:16px">
    <!-- Frases -->
    <div class="card">
      <p class="title">ğŸ’¬ Treino de frases</p>
      <div>
        <div><span class="chip">EN</span><span id="questionEn"></span></div>
        <div id="questionPtRow" class="muted" style="display:none"><span class="chip">PT</span><span id="questionPt"></span></div>
      </div>
      <div class="controls" style="margin:8px 0">
        <button id="btnPlayQ" class="secondary">ğŸ”Š Ouvir</button>
        <button id="btnNext" class="ghost">â¡ PrÃ³xima</button>
      </div>
      <details>
        <summary>ğŸ’¡ Resposta sugerida</summary>
        <div><span class="chip">EN</span><span id="answerEn"></span></div>
        <div class="muted"><span class="chip">PT</span><span id="answerPt"></span></div>
        <button id="btnPlayA" class="secondary">ğŸ”Š Ouvir resposta</button>
      </details>
      <div class="divider"></div>
      <p class="title">Responder</p>
      <input id="txtAnswer" type="text" placeholder="Digite em inglÃªs..."/>
      <div class="controls"><button id="btnCheck" class="ok">âœ… Verificar</button></div>
      <p id="feedbackMsg" class="feedback"></p>
      <div class="divider"></div>
      <p class="title">ğŸ™ï¸ Resposta por voz</p>
      <div class="controls">
        <button id="btnRec" class="warn">ğŸ¤ Gravar</button>
        <button id="btnVerifyRec" class="ok">ğŸ—£ï¸ Verificar</button>
      </div>
      <p id="heard" class="muted"></p>
      <p id="recSupport" class="hint"></p>
    </div>

    <!-- VocabulÃ¡rio -->
    <div class="card">
      <p class="title">ğŸ“– VocabulÃ¡rio</p>
      <select id="selTopic"></select>
      <div style="margin-top:8px">
        <div><span class="chip">EN</span><span id="vEn"></span></div>
        <div><span class="chip">PT</span><span id="vPt"></span></div>
        <p class="sub" id="vIdx"></p>
      </div>
      <div class="controls">
        <button id="btnPlayV" class="secondary">ğŸ”Š Ouvir</button>
        <button id="btnPrevV" class="ghost">â¬…</button>
        <button id="btnNextV" class="ghost">â¡</button>
      </div>
    </div>
  </div>

  <!-- HistÃ³rico -->
  <div class="card" style="margin-top:16px">
    <p class="title">ğŸ§¾ HistÃ³rico</p>
    <div id="histEmpty" class="muted">Nenhum registro ainda.</div>
    <div id="histTableWrap" style="display:none;overflow:auto">
      <table id="histTable"><thead><tr><th>NÃ­vel</th><th>Pergunta</th><th>Correta</th><th>VocÃª</th><th>Resultado</th><th>Similar</th></tr></thead><tbody></tbody></table>
    </div>
    <div class="divider"></div>
    <p class="title">ğŸ“Œ DifÃ­ceis</p>
    <div id="hardList" class="muted">Nenhum ğŸš€</div>
    <div class="controls" style="margin-top:8px">
      <button id="btnClearProgress" class="err">ğŸ—‘ï¸ Limpar tudo</button>
      <button id="btnClearDifficult" class="ghost">â™»ï¸ SÃ³ reforÃ§o</button>
    </div>
  </div>
</div>

<script>
/* === Estado === */
const DATA={frasesURL:"data/frases.json",vocabURL:"data/vocabulario.json"};
const LS_KEY="trainer_progress_v2",LS_SPEED="trainer_tts_speed";
function loadProgress(){try{return JSON.parse(localStorage.getItem(LS_KEY))||{score:0,streak:0,history:[],difficult:{},lastLevel:"FÃ¡cil",vocabIndexByTopic:{}}}catch(e){return{score:0,streak:0,history:[],difficult:{},lastLevel:"FÃ¡cil",vocabIndexByTopic:{}}}}
function saveProgress(){localStorage.setItem(LS_KEY,JSON.stringify(state.progress))}
const state={data:{frases:{FÃ¡cil:[],MÃ©dio:[],DifÃ­cil:[]},vocab:{}},level:"FÃ¡cil",showPt:false,current:null,transcribed:"",progress:loadProgress()};

/* === Util === */
function normalize(s){return(s||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim()}
function levRatio(a,b){a=normalize(a);b=normalize(b);const m=a.length,n=b.length;if(!m&&!n)return 1;const dp=Array.from({length:m+1},()=>Array(n+1).fill(0));for(let i=0;i<=m;i++)dp[i][0]=i;for(let j=0;j<=n;j++)dp[0][j]=j;for(let i=1;i<=m;i++){for(let j=1;j<=n;j++){const c=a[i-1]===b[j-1]?0:1;dp[i][j]=Math.min(dp[i-1][j]+1,dp[i][j-1]+1,dp[i-1][j-1]+c)}}return 1-dp[m][n]/Math.max(m,n)}
function classify(u,c){const r=levRatio(u,c);if(r>=.99)return{status:"ok",msg:"âœ… Correto!",inc:1,sim:r};if(r>=.9)return{status:"info",msg:`Quase (${Math.round(r*100)}%)`,inc:0,sim:r};if(r>=.75)return{status:"warn",msg:`Pequeno erro (${Math.round(r*100)}%)`,inc:0,sim:r};return{status:"err",msg:`Errado (${Math.round(r*100)}%)`,inc:0,sim:r}}

/* === TTS === */
let speechRate=parseFloat(localStorage.getItem(LS_SPEED))||1;
const rateInput=document.getElementById("globalSpeed"),rateLabel=document.getElementById("globalSpeedValue");
if(rateInput){rateInput.value=speechRate;rateInput.addEventListener("input",()=>{speechRate=parseFloat(rateInput.value);localStorage.setItem(LS_SPEED,speechRate);rateLabel.textContent=speechRate.toFixed(1)+"x";if("speechSynthesis"in window)speechSynthesis.cancel()});rateLabel.textContent=speechRate+"x"}
function speakEn(t){if(!t)return;if(!("speechSynthesis"in window)){alert("TTS nÃ£o suportado");return}const u=new SpeechSynthesisUtterance(t);u.lang="en-US";u.rate=speechRate;const v=speechSynthesis.getVoices();u.voice=v.find(x=>/en/i.test(x.lang))||v[0];speechSynthesis.cancel();speechSynthesis.speak(u)}

/* === STT === */
let rec=null,recActive=false;function initRecognizer(){const R=window.SpeechRecognition||window.webkitSpeechRecognition;if(!R){document.getElementById("recSupport").textContent="STT nÃ£o suportado";return}rec=new R();rec.lang="en-US";rec.onresult=e=>{state.transcribed=e.results[0][0].transcript;document.getElementById("heard").textContent="VocÃª disse: "+state.transcribed};rec.onend=()=>{recActive=false;document.getElementById("btnRec").textContent="ğŸ¤ Gravar"};document.getElementById("recSupport").textContent="Dica: fale pausadamente"} 

/* === Dados === */
async function loadData(){const [fr,vb]=await Promise.all([fetch(DATA.frasesURL).then(r=>r.json()),fetch(DATA.vocabURL).then(r=>r.json())]);state.data.frases.FÃ¡cil=fr.FÃ¡cil||[];state.data.frases.MÃ©dio=fr.MÃ©dio||[];state.data.frases.DifÃ­cil=fr.DifÃ­cil||[];state.data.vocab=vb||{};initVocab();pickNext()}

/* === Frases === */
function pickNext(){const pool=state.data.frases[state.level]||[];if(!pool.length)return;state.current=pool[Math.floor(Math.random()*pool.length)];renderQA(true)}
function renderQA(reset){if(!state.current)return;document.getElementById("questionEn").textContent=state.current.pergunta||state.current.en_q;document.getElementById("questionPt").textContent=state.current.pt_q||state.current.traducao;document.getElementById("answerEn").textContent=state.current.resposta||state.current.en_a;document.getElementById("answerPt").textContent=state.current.pt_a||"";document.getElementById("questionPtRow").style.display=(state.level==="FÃ¡cil"||state.showPt)?"block":"none";if(reset)document.getElementById("txtAnswer").value=""}

/* === VerificaÃ§Ã£o === */
function verifyAnswer(txt){const c=state.current.resposta||state.current.en_a;const r=classify(txt,c);state.progress.score+=r.inc;state.progress.streak=r.inc?state.progress.streak+1:0;saveProgress();renderKPIs();const fb=document.getElementById("feedbackMsg");fb.className="feedback "+r.status;fb.textContent=r.msg;}

/* === KPIs === */
function renderKPIs(){document.getElementById("kpiScore").textContent=state.progress.score;document.getElementById("kpiStreak").textContent=state.progress.streak}

/* === Vocab === */
function initVocab(){const sel=document.getElementById("selTopic");sel.innerHTML="";Object.keys(state.data.vocab).forEach(t=>{const o=document.createElement("option");o.value=t;o.textContent=t;sel.appendChild(o)});renderVocabWord(sel.value)}
function renderVocabWord(topic){const arr=state.data.vocab[topic]||[];if(!arr.length)return;const idx=0;document.getElementById("vEn").textContent=arr[idx].en;document.getElementById("vPt").textContent=arr[idx].pt;document.getElementById("vIdx").textContent=`1 / ${arr.length}`}

/* === Eventos === */
document.getElementById("btnPlayQ").onclick=()=>speakEn(state.current?.pergunta||"");
document.getElementById("btnPlayA").onclick=()=>speakEn(state.current?.resposta||"");
document.getElementById("btnCheck").onclick=()=>verifyAnswer(document.getElementById("txtAnswer").value);
document.getElementById("btnNext").onclick=pickNext;
document.getElementById("btnRec").onclick=()=>{if(!rec)return;if(recActive){rec.stop();recActive=false}else{recActive=true;rec.start();document.getElementById("btnRec").textContent="â¹ï¸ Parar"}}
document.getElementById("btnVerifyRec").onclick=()=>verifyAnswer(state.transcribed||"")
document.getElementById("btnPlayV").onclick=()=>{const t=document.getElementById("selTopic").value;const it=state.data.vocab[t][0];if(it)speakEn(it.en)}

/* === Init === */
(async function(){await loadData();initRecognizer();renderKPIs()})();
</script>
</body>
</html>
