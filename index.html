<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>English Dialogue Trainer ‚Äì Web</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0ea5e9" />
  <style>
    :root{
      --bg:#0b1220; --card:#0f172a; --muted:#94a3b8; --text:#e2e8f0; --brand:#0ea5e9; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444;
      --soft:#1e293b;
    }
    *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(180deg,#0b1220,#0b1220 50%,#101a34);color:var(--text)}
    .app{max-width:1100px;margin:0 auto;padding:24px}
    .header{display:flex;gap:12px;align-items:center;margin-bottom:16px}
    .badge{background:rgba(14,165,233,.15);border:1px solid rgba(14,165,233,.35);color:#7dd3fc;padding:2px 8px;border-radius:999px;font-size:12px}
    h1{margin:0;font-size:22px}
    .row{display:grid;gap:16px}
    @media (min-width:1000px){.row{grid-template-columns:2fr 1fr}}
    .card{background:linear-gradient(180deg,rgba(148,163,184,.1),rgba(148,163,184,.03));border:1px solid rgba(148,163,184,.18);border-radius:16px;padding:16px}
    .title{font-size:16px;margin:0 0 8px 0;color:#cbd5e1}
    .sub{font-size:13px;color:var(--muted);margin:0 0 12px}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    button, .btn{background:linear-gradient(180deg,#0ea5e9,#0284c7);border:none;color:white;padding:10px 12px;border-radius:12px;cursor:pointer;font-weight:600}
    button.secondary{background:linear-gradient(180deg,#1f2937,#111827);border:1px solid #334155}
    button.ghost{background:transparent;border:1px solid #334155}
    button.ok{background:linear-gradient(180deg,#22c55e,#16a34a)}
    button.warn{background:linear-gradient(180deg,#f59e0b,#d97706)}
    button.err{background:linear-gradient(180deg,#ef4444,#dc2626)}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    .grid2{display:grid;gap:12px}
    @media(min-width:700px){.grid2{grid-template-columns:1fr 1fr}}
    .pill{display:inline-flex;gap:8px;align-items:center;background:#0b1020;border:1px solid #26314b;color:#8ab4ff;padding:6px 10px;border-radius:999px;font-size:12px}
    .divider{height:1px;background:rgba(148,163,184,.18);margin:16px 0}
    .muted{color:var(--muted)}
    input[type="text"]{width:100%;padding:12px 12px;border-radius:12px;border:1px solid #334155;background:#0b1020;color:var(--text)}
    .kpi{display:flex;gap:12px;flex-wrap:wrap}
    .kpi .item{background:#0b1020;border:1px solid #334155;border-radius:12px;padding:8px 12px}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{border-bottom:1px dashed rgba(148,163,184,.2);padding:8px 6px;text-align:left}
    .chip{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #334155;background:#0b1020;font-size:12px;color:#a5b4fc}
    details{border:1px solid #334155;border-radius:12px;padding:10px}
    summary{cursor:pointer;color:#a5b4fc}
    .hint{font-size:13px;color:#93c5fd}
      /* Estilo do bot√£o fixo */
    #clearHistoryBtn {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: #ff4d4d;
    color: white;
    border: none;
    padding: 12px 16px;
    border-radius: 8px;
    font-size: 16px;
    cursor: pointer;
    box-shadow: 0 4px 6px rgba(0,0,0,0.2);
    transition: background 0.3s;
    }
    #clearHistoryBtn:hover {
    background: #cc0000;
    }
  </style>
</head>
<body>
<div class="app">
  <div class="header">
    <span class="badge">üì¶ Almoxarifado + Conversa√ß√£o</span>
    <h1>English Dialogue Trainer ‚Äì Web</h1>
  </div>
  <p class="sub">Perguntas e respostas aparecem em <b>ingl√™s</b> com <b>tradu√ß√£o em portugu√™s</b> (dependendo do n√≠vel). Voz: texto ‚Üí fala e fala ‚Üí texto (quando suportado).</p>

  <!-- Config -->
  <div class="card">
    <p class="title">Configura√ß√µes ‚Ä¢ N√≠vel e Ajuda</p>
    <div class="controls" id="levelControls">
      <label><input type="radio" name="level" value="F√°cil" checked> F√°cil</label>
      <label><input type="radio" name="level" value="M√©dio"> M√©dio</label>
      <label><input type="radio" name="level" value="Dif√≠cil"> Dif√≠cil</label>
      <label style="margin-left:12px"><input type="checkbox" id="ckShowPt"> Mostrar tradu√ß√£o (M√©dio / Dif√≠cil)</label>
    </div>
    <div class="kpi" style="margin-top:8px">
      <div class="item">Pontua√ß√£o: <b id="kpiScore">0</b></div>
      <div class="item">üî• Streak: <b id="kpiStreak">0</b></div>
    </div>

    <!-- Controle de velocidade global -->
    <div style="margin-top:12px">
      <label for="globalSpeed" style="margin-right:8px">Velocidade do √°udio:</label>
      <input id="globalSpeed" type="range" min="0.5" max="2" step="0.1" value="1">
      <span id="globalSpeedValue">1x</span>
    </div>
  </div>

  <div class="row" style="margin-top:16px">
    <!-- Treino de frases -->
    <div class="card">
      <p class="title">Frase para treinar</p>
      <div id="qaArea">
        <div style="margin-bottom:6px"><span class="chip">EN</span> <span id="questionEn" class="mono"></span></div>
        <div id="questionPtRow" class="muted" style="display:none;margin-bottom:10px"><span class="chip">PT</span> <span id="questionPt"></span></div>
        <div class="controls" style="margin-top:8px">
          <button id="btnPlayQ" class="secondary">üîä Ouvir pergunta (EN)</button>
          <button id="btnNext" class="ghost">‚û° Pr√≥xima</button>
        </div>
      </div>

      <div class="divider"></div>

      <details>
        <summary>üí° Resposta sugerida</summary>
        <div style="margin-top:8px">
          <div style="margin-bottom:6px"><span class="chip">EN</span> <span id="answerEn" class="mono"></span></div>
          <div class="muted" style="margin-bottom:10px"><span class="chip">PT</span> <span id="answerPt"></span></div>
          <button id="btnPlayA" class="secondary">üîä Ouvir resposta (EN)</button>
        </div>
      </details>

      <div class="divider"></div>

      <div class="grid2">
        <div>
          <p class="title">Responder por texto</p>
          <input type="text" id="txtAnswer" placeholder="Digite sua resposta em ingl√™s‚Ä¶" />
          <div class="controls" style="margin-top:8px">
            <button id="btnCheck" class="ok">‚úÖ Verificar (texto)</button>
          </div>
          <p id="feedbackMsg" class="sub"></p>
        </div>
        <div>
          <p class="title">üéôÔ∏è Responder falando</p>
          <div class="controls">
            <button id="btnRec" class="warn">üé§ Gravar / Parar</button>
            <button id="btnVerifyRec" class="ok">üó£Ô∏è Transcrever e verificar</button>
          </div>
          <p id="heard" class="muted" style="margin-top:6px"></p>
          <p id="recSupport" class="hint"></p>
        </div>
      </div>
    </div>

    <!-- Vocabul√°rio -->
    <div class="card">
      <p class="title">üìñ Vocabul√°rio por t√≥picos</p>
      <div class="controls" style="margin-bottom:8px">
        <select id="selTopic"></select>
      </div>
      <div id="vocabOne">
        <div class="muted" style="margin-bottom:10px"><span class="chip">EN</span> <span id="vEn"></span></div>
        <div style="margin-bottom:6px"><span class="chip">PT</span> <span id="vPt" class="mono"></span></div>
        <div class="controls">
          <button id="btnPlayV" class="secondary">üîä Ouvir palavra (EN)</button>
          <button id="btnPrevV" class="ghost">‚¨Ö Anterior</button>
          <button id="btnNextV" class="ghost">‚û° Pr√≥xima</button>
        </div>
        <p class="sub" id="vIdx"></p>
      </div>
    </div>
    
  </div>

  <!-- Hist√≥rico -->
  <div class="card" style="margin-top:16px">
    <p class="title">üßæ Hist√≥rico de respostas</p>
    <div id="histEmpty" class="muted">Nenhum registro ainda.</div>
    <div id="histTableWrap" style="display:none;overflow:auto">
      <table id="histTable">
        <thead>
          <tr><th>N√≠vel</th><th>Pergunta (EN)</th><th>Correta (EN)</th><th>Voc√™</th><th>Resultado</th><th>Similar</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="divider"></div>
    <p class="title">üìå Palavras/frases dif√≠ceis (refor√ßo)</p>
    <div id="hardList" class="muted">Nenhuma por enquanto üöÄ</div>

    <!-- bot√µes para limpar progresso -->
    <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
      <button id="btnClearProgress" class="err">üóëÔ∏è Limpar hist√≥rico e refor√ßo</button>
      <button id="btnClearDifficult" class="ghost">‚ôªÔ∏è Limpar apenas refor√ßo</button>
    </div>
  </div>

</div>

<script>
/* =========================================================
   Config / Estado
   ========================================================= */
const DATA = {
  frasesURL: 'data/frases.json',
  vocabURL: 'data/vocabulario.json'
};

const LS_KEY = 'trainer_progress_v2';
const LS_SPEED = 'trainer_tts_speed';

function loadProgress(){
  try {
    return JSON.parse(localStorage.getItem(LS_KEY)) || {
      score:0, streak:0, history:[], difficult:{}, lastLevel:'F√°cil', vocabIndexByTopic:{}
    };
  } catch(e){
    return {score:0, streak:0, history:[], difficult:{}, lastLevel:'F√°cil', vocabIndexByTopic:{}};
  }
}
function saveProgress(){ localStorage.setItem(LS_KEY, JSON.stringify(state.progress)); }

/* global app state */
const state = {
  data:{ frases:{F√°cil:[],M√©dio:[],Dif√≠cil:[]}, vocab:{} },
  level:'F√°cil',
  showPt:false,
  current:null,
  transcribed:'',
  progress: loadProgress()
};

/* =========================================================
   Utilit√°rios
   ========================================================= */
function normalize(s){ return (s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9' ]+/g,' ').replace(/\s+/g,' ').trim(); }
function levRatio(a,b){
  a = normalize(a); b = normalize(b);
  const m=a.length, n=b.length;
  if(m===0 && n===0) return 1;
  const dp = Array.from({length:m+1},()=>Array(n+1).fill(0));
  for(let i=0;i<=m;i++) dp[i][0]=i;
  for(let j=0;j<=n;j++) dp[0][j]=j;
  for(let i=1;i<=m;i++){
    for(let j=1;j<=n;j++){
      const cost = a[i-1]===b[j-1]?0:1;
      dp[i][j]=Math.min(dp[i-1][j]+1, dp[i][j-1]+1, dp[i-1][j-1]+cost);
    }
  }
  const dist = dp[m][n];
  return 1 - dist / Math.max(m,n);
}
function classify(user, correct){
  const r = levRatio(user, correct);
  if(r >= 0.99) return {status:'success', msg:'‚úÖ Correto!', inc:1, sim:r};
  if(r >= 0.90) return {status:'info', msg:`Quase perfeito (${Math.round(r*100)}%)`, inc:0, sim:r};
  if(r >= 0.75) return {status:'info', msg:`Pequeno erro (${Math.round(r*100)}%)`, inc:0, sim:r};
  if(r >= 0.60) return {status:'warn', msg:`Erro moderado (${Math.round(r*100)}%)`, inc:0, sim:r};
  return {status:'err', msg:`Muito diferente (${Math.round(r*100)}%)`, inc:0, sim:r};
}

/* =========================================================
   TTS ‚Äì controle de velocidade global
   ========================================================= */
let speechRate = parseFloat(localStorage.getItem(LS_SPEED)) || 1.0;
const rateInput = document.getElementById('globalSpeed');
const rateLabel = document.getElementById('globalSpeedValue');

function updateRate(){
  speechRate = parseFloat(rateInput.value) || 1.0;
  rateLabel.textContent = speechRate.toFixed(1) + 'x';
  localStorage.setItem(LS_SPEED, speechRate);
  if('speechSynthesis' in window) speechSynthesis.cancel();
}
if(rateInput){
  rateInput.value = speechRate;
  rateInput.addEventListener('input', updateRate);
  updateRate();
}

function speakEn(text){
  if(!text) return;
  if(!('speechSynthesis' in window)) { alert('TTS n√£o suportado neste navegador.'); return; }
  const u = new SpeechSynthesisUtterance(text);
  u.lang = 'en-US';
  u.rate = speechRate;
  u.pitch = 1;
  const vs = speechSynthesis.getVoices();
  const pref = vs.find(v=>/en(-|_)?(US|GB|AU|CA|IN)?/i.test(v.lang)) || vs[0];
  if(pref) u.voice = pref;
  speechSynthesis.cancel();
  if(speechSynthesis.getVoices().length === 0){
    speechSynthesis.onvoiceschanged = ()=>{ speechSynthesis.speak(u); };
    setTimeout(()=>{ if(!speechSynthesis.speaking) speechSynthesis.speak(u); }, 120);
  }else{
    speechSynthesis.speak(u);
  }
}

/* =========================================================
   Carregar dados (frases e vocabul√°rio)
   ========================================================= */
async function loadData(){
  try{
    const [frRes, vbRes] = await Promise.all([
      fetch(DATA.frasesURL), fetch(DATA.vocabURL)
    ]);
    const fr = await frRes.json();
    const vb = await vbRes.json();
    state.data.frases.F√°cil = Array.isArray(fr['F√°cil']) ? fr['F√°cil'] : [];
    state.data.frases.M√©dio = Array.isArray(fr['M√©dio']) ? fr['M√©dio'] : [];
    state.data.frases.Dif√≠cil = Array.isArray(fr['Dif√≠cil']) ? fr['Dif√≠cil'] : [];
    state.data.vocab = vb || {};
    initVocab(); // ‚úÖ inicializa vocabul√°rio assim que carregar
  }catch(e){
    alert('Falha ao carregar os arquivos JSON.');
    console.error(e);
  }
}

/* =========================================================
   Vocabul√°rio
   ========================================================= */
function initVocab(){
  const sel = document.getElementById('selTopic');
  sel.innerHTML = '';
  const topics = Object.keys(state.data.vocab || {});
  topics.forEach(t=>{
    const opt = document.createElement('option');
    opt.value = t; opt.textContent = t;
    sel.appendChild(opt);
  });
  const first = topics[0] || '';
  if(first) sel.value = first;
  renderVocabWord(first);
}

function getVIndex(topic){
  const n = (state.progress.vocabIndexByTopic[topic] ?? 0);
  const arr = state.data.vocab[topic] || [];
  return Math.min(Math.max(n,0), Math.max(0, arr.length-1));
}

function renderVocabWord(topic){
  const arr = state.data.vocab[topic] || [];
  if(!arr.length) return;
  const idx = getVIndex(topic);
  const w = arr[idx];
  document.getElementById('vEn').textContent = w.en;
  document.getElementById('vPt').textContent = w.pt;
  document.getElementById('vIdx').textContent = `${idx+1} / ${arr.length}`;
  document.getElementById('btnPlayV').onclick = ()=> speakEn(w.en);
}

/* =========================================================
   Hist√≥rico e limpar progresso
   ========================================================= */
function renderHistory(){
  const wrap = document.getElementById('histTableWrap');
  const empty = document.getElementById('histEmpty');
  const tbody = document.querySelector('#histTable tbody');
  tbody.innerHTML = '';
  if(!state.progress.history.length){
    wrap.style.display='none';
    empty.style.display='block';
    return;
  }
  wrap.style.display='block';
  empty.style.display='none';
  state.progress.history.slice().reverse().forEach(entry=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${entry.level}</td>
      <td class="mono">${entry.question}</td>
      <td class="mono">${entry.answerCorrect}</td>
      <td class="mono">${entry.answerUser}</td>
      <td>${entry.result}</td>
      <td>${entry.similarity}</td>
    `;
    tbody.appendChild(tr);
  });
}

function renderDifficult(){
  const div = document.getElementById('hardList');
  const entries = Object.entries(state.progress.difficult || {}).sort((a,b)=>b[1]-a[1]);
  if(!entries.length){ div.textContent='Nenhuma por enquanto üöÄ'; return; }
  div.innerHTML = entries.map(([k,v])=>`‚Ä¢ ${k} <span class="muted">(erros: ${v})</span>`).join('<br/>');
}

function clearProgressAll(){
  if(!confirm('Tem certeza que deseja limpar hist√≥rico e refor√ßo?')) return;
  state.progress.history = [];
  state.progress.difficult = {};
  state.progress.score = 0;
  state.progress.streak = 0;
  saveProgress();
  renderHistory();
  renderDifficult();
}

function clearDifficultOnly(){
  if(!confirm('Limpar apenas a lista de refor√ßo?')) return;
  state.progress.difficult = {};
  saveProgress();
  renderDifficult();
}

/* =========================================================
   Inicializa√ß√£o
   ========================================================= */
window.onload = async ()=>{
  await loadData();
  renderHistory();
  renderDifficult();
  document.getElementById('btnClearProgress').onclick = clearProgressAll;
  document.getElementById('btnClearDifficult').onclick = clearDifficultOnly;
};
</script>

</body>
</html>
